@defer (when tableoptions) {
    @if (data$ | async; as data) {
        @if (data && data.length !== 0) {
            <!-- {{ data | json }} -->
            <div class="relative left-0 right-0 flex flex-col w-full overflow-auto scrollbar-hide rounded-b-lg" cdk-scrollable #scrollableContent>
                <table mat-table [dataSource]="dataSource" matSort class="relative w-full" multiTemplateDataRows>
                    <ng-container matColumnDef="sortrow" [sticky]="tableoptions.sortRowManual">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let element; let i = index">
                            <div class="absolute h-6 w-6 -my-3 opacity-0 bg-tertiary text-borderline group-hover:opacity-100 transition-opacity ease-in-out duration-500 cursor-grab">
                                <icons class="stroke-1 stroke-current" name="dots-block"></icons>
                            </div>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="unread" [sticky]="tableoptions.unread">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let element; let i = index">
                            <div class=" h-6 w-6 text-transparent fill-accent cursor-pointer">
                                <icons class="w-8 h-8 stroke-1 stroke-current" name="dot"></icons>
                            </div>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="count" [sticky]="tableoptions.count">
                        <th mat-header-cell *matHeaderCellDef> Nr. </th>
                        <td mat-cell *matCellDef="let element; let i = index">{{ this.paginator!.pageIndex == 0 ? i + 1 : 1 + i + this.paginator!.pageIndex * this.paginator!.pageSize }}</td>
                    </ng-container>
                    <ng-container matColumnDef="checkbox" [sticky]="tableoptions.checkbox">
                        <th mat-header-cell *matHeaderCellDef>
                            <div class="p-2">
                                <div class="w-5 h-5 bg-light rounded-sm" (click)="checkAll()">
                                    <input type="checkbox" class="w-full h-full focus:outline-none cursor-pointer" />
                                </div>
                            </div>
                        </th>
                        <td mat-cell *matCellDef="let element; let i = index">
                            <div class="p-2">
                                <div class="w-5 h-5 bg-light rounded-sm" (click)="check(element)">
                                    <input type="checkbox" class="w-full h-full focus:outline-none cursor-pointer" [checked]="element['checked']"/>
                                </div>
                            </div>
                        </td>
                    </ng-container>

                    @for (column of tableoptions.columns; track $index) {
                        <ng-container matColumnDef="{{ column.name }}">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header [disabled]="!column.sortable" [ngClass]="{'hidden': column.hidden}"> {{ column.header }} </th>
                            <td mat-cell *matCellDef="let element" [ngClass]="{'hidden': column.hidden}">
                                @if (isEditable$ | async) {
                                    @switch (true) {
                                        @case (column.type == 'checkbox') {
                                            <input type="checkbox" [checked]="element[column.cell]" />
                                            <!-- [disabled]="column.disabled" -->
                                        }
                                        @case (column.type == 'datetime-local') {
                                            @if (column.pipe) {
                                                <input [type]="column.type" [value]="element[column.cell] | dynamicPipe: column.pipe!.name: column.pipe!.args" />
                                            } 
                                            @else {
                                                <input [type]="column.type" [value]="element[column.cell]" />
                                            }                                            
                                        }
                                        @default {
                                            <input [type]="column.type" [value]="element[column.cell]" />                                           
                                        }
                                    }
                                }
                                @else {
                                    @switch (true) {
                                        @case (column.type == 'checkbox') {
                                            <input type="checkbox" [checked]="element[column.cell]" [disabled]="column.disabled">
                                        }
                                        @case (column.type == 'datetime-local') {
                                            @if (!column.pipe) {
                                                {{ element[column.cell] }}
                                            } 
                                            @else {
                                                {{ element[column.cell] | dynamicPipe: column.pipe!.name: column.pipe!.args }}
                                            }                                            
                                        }
                                        @default {
                                            @if (!column.pipe) {
                                                {{ element[column.cell] }}
                                            } 
                                            @else {
                                                {{ element[column.cell] | dynamicPipe: column.pipe!.name: column.pipe!.args }}
                                            }                                            
                                        }
                                    }
                                }
                            </td>
                        </ng-container>
                    }
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let element">
                            <button [matMenuTriggerFor]="menu" class="w-full">
                                <div class=" h-6 w-6 text-dark fill-dark">
                                    <icons class="w-8 h-8 stroke-1 stroke-current" name="dots"></icons>
                                </div>
                            </button>
                            
                            <mat-menu #menu="matMenu">
                                @for (action of tableoptions.actions; track $index) {
                                    <button mat-menu-item class="!flex items-center" (click)="clickAction(element.id, action.action)">
                                        <div class="flex flex-row">
                                            <div class=" h-6 w-6 fill-dark">
                                                <icons class="w-8 h-8 stroke-1 stroke-current" name="{{ action.icon }}"></icons>
                                            </div>
                                            <span class="ml-4">{{ action.name }}</span>
                                        </div>
                                    </button>
                                }
                            </mat-menu>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="expand" [sticky]="tableoptions.isExpandable">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let element">
                            <button mat-icon-button (click)="expand(element); $event.stopPropagation()">
                                @if (expandedElement === element) {
                                    <div class=" h-6 w-6 text-dark fill-dark">
                                        <icons class="w-8 h-8 stroke-1 stroke-current" name="chevron-up"></icons>
                                    </div>
                                } @else {
                                    <div class=" h-6 w-6 text-dark fill-dark">
                                        <icons class="w-8 h-8 stroke-1 stroke-current" name="chevron-down"></icons>
                                    </div>
                                }
                            </button>                        
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="expandedDetail">
                        <td mat-cell *matCellDef="let object" [attr.colspan]="tableoptions.columnNames?.length">
                            <div [@collapse]="object == expandedElement">
                                <ng-container *ngTemplateOutlet="getExpandTemplate('expandtemplate'); context: { object }"></ng-container>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="tableoptions.columnNames; sticky: false"></tr>
                    <tr mat-row *matRowDef="let row; columns: tableoptions.columnNames;" (click)="edit(row)" class="group" [@hide]="true"></tr>
                    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
                </table>
                <div [ngClass]="{'border-t border-borderline': dataSource.data.length > pageSize}">
                    @if (tableoptions.paginator) {
                        <!-- <mat-paginator class="sticky bottom-0 z-10" *ngIf="table.showPaginator" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" (page)="updatePaginator()"></mat-paginator> -->
                        <mat-paginator MobilePagination [appCustomLength]="dataSource.data.length" [hideHowManyDisplayedEl]="true" [length]="dataSource.data.length" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" (page)="updatePaginator()"></mat-paginator>
                    }
                </div>
            </div>
        } @else {
            <!-- No data state -->
        }
    }
} @placeholder {
    <div class="absolute flex h-12 w-full justify-center inset-0 text-gray-400">
        <div class="flex flex-col items-center text-lg">
            <div class="w-8 h-8 fill-blue-600 text-gray-200 animate-spin">
                <icons class="" name="spinner"></icons>
            </div>
            <span class="mt-2">Tabelle wird vorbereitet...</span>
        </div>
    </div>
} @loading {
    <div class="absolute flex h-12 w-full justify-center inset-0 text-gray-400">
        <div class="flex flex-col items-center text-lg">
            <div class="w-8 h-8 fill-blue-600 text-gray-200 animate-spin">
                <icons class="" name="spinner"></icons>
            </div>
            <span class="mt-2">Daten werden geladen...</span>
        </div>
    </div>
} @error {
    <div class="absolute flex h-12 w-full justify-center inset-0 text-gray-400">
        <div class="flex flex-col items-center text-lg">
            <div class="w-8 h-8 mr-2">
                <icons class="stroke-2 stroke-current" name="alert-triangle"></icons>
            </div>
            <span>Es kam zu einem unerwarteten Fehler!</span>
        </div>
    </div>
}